é€™æ˜¯ç¶“éé™¤éŒ¯èˆ‡å„ªåŒ–å¾Œçš„**ã€ŒCiÃ© CiÃ© Taipei æ™ºæ…§è¨‚ä½ç³»çµ±çµ‚æ¥µæ¶æ§‹æ‰‹å†Šã€**ã€‚

---

# ğŸ¸ CiÃ© CiÃ© Taipei æ™ºæ…§è¨‚ä½ç³»çµ±æ¶æ§‹æ‰‹å†Š (v2.0 æœ€çµ‚ç‰ˆ)

## ğŸ“Œ 1. ç³»çµ±å…¨è²Œåœ–

* **æ ¸å¿ƒå¤§è…¦ (Database):** **Supabase** (å„²å­˜æ‰€æœ‰è¨‚å–®è³‡æ–™)ã€‚
* **é¡§å®¢å…¥å£ (Frontend):** **GitHub Pages (`booking.html`)** â” åµŒå…¥ **HF Space A**ã€‚
* åŠŸèƒ½ï¼šå¡«å¯«è¨‚å–®ã€å¯«å…¥è³‡æ–™åº«ã€ç™¼é€ LINE é€šçŸ¥çµ¦è€é—†ã€‚


* **è€é—†å¾Œå° (Backend):** **GitHub Pages (`admin.html`)** â” åµŒå…¥ **HF Space B**ã€‚
* åŠŸèƒ½ï¼šæŸ¥çœ‹è¨‚å–®ã€ç™¼é€ç¢ºèªä¿¡ (å«ç¢ºèª/å–æ¶ˆé€£çµ)ã€‚


* **éƒµå·® (Email):** **Google Apps Script (GAS)** (è² è²¬å¯„é€ HTML ç¢ºèªä¿¡)ã€‚

---

## ğŸ”§ ç¬¬ä¸€æ­¥ï¼šè³‡æ–™åº«è¨­å®š (Supabase)

1. é€²å…¥ Supabase å°ˆæ¡ˆçš„ **SQL Editor**ï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å»ºç«‹è¡¨æ ¼ï¼š
```sql
create table bookings (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name text not null,     -- å§“å
  tel text not null,      -- é›»è©±
  email text,             -- Email
  date text not null,     -- æ—¥æœŸ
  time text not null,     -- æ™‚é–“
  pax int not null,       -- äººæ•¸
  remarks text,           -- å‚™è¨»
  status text default 'å¾…è™•ç†' -- ç‹€æ…‹ï¼šå¾…è™•ç†, å·²ç™¼ç¢ºèªä¿¡, é¡§å®¢å·²ç¢ºèª, é¡§å®¢å·²å–æ¶ˆ
);

```


2. å‰å¾€ **Project Settings > API**ï¼Œè¨˜ä¸‹ï¼š
* **Project URL** (`SUPABASE_URL`)
* **anon public key** (`SUPABASE_KEY`)



---

## ğŸ“§ ç¬¬äºŒæ­¥ï¼šè¨­å®š GAS ç™¼ä¿¡ä¸­ç¹¼ç«™

1. å‰å¾€ [Google Apps Script](https://script.google.com/) å»ºç«‹æ–°å°ˆæ¡ˆã€‚
2. è²¼ä¸Šä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š
```javascript
function doPost(e) {
  try {
    var param = JSON.parse(e.postData.contents);
    MailApp.sendEmail({
      to: param.to,
      subject: param.subject,
      htmlBody: param.htmlBody,
      name: param.name
    });
    return ContentService.createTextOutput(JSON.stringify({ "status": "success" })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ "status": "error" })).setMimeType(ContentService.MimeType.JSON);
  }
}

```


3. **éƒ¨ç½² (é—œéµ)ï¼š** é»æ“Šã€Œéƒ¨ç½²ã€>ã€Œæ–°å¢éƒ¨ç½²ã€>ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚
* åŸ·è¡Œèº«åˆ†ï¼š**æˆ‘ (Me)**ã€‚
* èª°å¯ä»¥å­˜å–ï¼š**æ‰€æœ‰äºº (Anyone)** âš ï¸ã€‚


4. è¤‡è£½å¾—åˆ°çš„ **Web App URL** (é€™å°±æ˜¯ `GAS_MAIL_URL`)ã€‚

---

## ğŸ—ï¸ ç¬¬ä¸‰æ­¥ï¼šSpace A (é¡§å®¢å‰ç«¯åŠŸèƒ½)

**è² è²¬ï¼š** é¡¯ç¤ºè¨‚ä½è¡¨å–®ã€é˜²å‘†æª¢æŸ¥ã€å¯«å…¥ DBã€LINE é€šçŸ¥ã€æ¥æ”¶ç¢ºèª/å–æ¶ˆé€£çµã€‚

1. **Hugging Face è¨­å®šï¼š**
* Visibility: **Public**
* **Secrets:** `SUPABASE_URL`, `SUPABASE_KEY`, `LINE_ACCESS_TOKEN`, `LINE_ADMIN_ID`


2. **Files > requirements.txt:**
```text
gradio
supabase
requests

```


3. **Files > app.py (å®Œæ•´æœ€çµ‚ç‰ˆ):**

```python
import gradio as gr
import os
import requests
from supabase import create_client, Client
from datetime import datetime, timedelta, timezone

# è¨­å®šå°åŒ—æ™‚å€
TAIPEI_TZ = timezone(timedelta(hours=8))

# --- é€£ç·šè¨­å®š ---
LINE_ACCESS_TOKEN = os.getenv("LINE_ACCESS_TOKEN")
LINE_ADMIN_ID = os.getenv("LINE_ADMIN_ID")
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")

if SUPABASE_URL and SUPABASE_KEY:
    supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
else:
    print("âš ï¸ è­¦å‘Šï¼šSUPABASE ç’°å¢ƒè®Šæ•¸æœªè¨­å®š")

# --- è¼”åŠ©å‡½å¼ ---
def get_date_options():
    options = []
    today = datetime.now(TAIPEI_TZ) # ä¿®æ­£æ™‚å€å•é¡Œ
    weekdays = ["(ä¸€)", "(äºŒ)", "(ä¸‰)", "(å››)", "(äº”)", "(å…­)", "(æ—¥)"]
    for i in range(30): 
        current_date = today + timedelta(days=i)
        date_str = f"{current_date.strftime('%Y-%m-%d')} {weekdays[current_date.weekday()]}"
        options.append(date_str)
    return options

def update_time_slots(date_str):
    if not date_str: return gr.update(choices=[]), "è«‹å…ˆé¸æ“‡æ—¥æœŸ"
    try:
        clean_date_str = date_str.split(" ")[0] 
        date_obj = datetime.strptime(clean_date_str, "%Y-%m-%d")
        weekday = date_obj.weekday() 
    except: return gr.update(choices=[]), "æ—¥æœŸæ ¼å¼éŒ¯èª¤"

    slots = ["18:00", "18:30", "19:00", "19:30", "20:00", "20:30", 
             "21:00", "21:30", "22:00", "22:30", "23:00", "23:30", "00:00", "00:30", "01:00"]
    
    if weekday == 4 or weekday == 5: 
        slots.extend(["01:30", "02:00", "02:30"])
        status_msg = f"âœ¨ å·²é¸æ“‡ {date_str} (é€±æœ«ç‡Ÿæ¥­è‡³ 03:00)"
    else:
        slots.extend(["01:30"])
        status_msg = f"ğŸŒ™ å·²é¸æ“‡ {date_str} (å¹³æ—¥ç‡Ÿæ¥­è‡³ 02:00)"
    return gr.update(choices=slots, value=slots[0] if slots else None), status_msg

# --- LINE é€šçŸ¥ ---
def send_line_notify(data):
    if not LINE_ACCESS_TOKEN or not LINE_ADMIN_ID: return
    message = (f"ğŸ”¥ æ–°è¨‚ä½é€šçŸ¥ ğŸ”¥\nå§“åï¼š{data['name']}\né›»è©±ï¼š{data['tel']}\næ—¥æœŸï¼š{data['date']} {data['time']}\näººæ•¸ï¼š{data['pax']} ä½\nEmailï¼š{data.get('email', '-')}\nå‚™è¨»ï¼š{data.get('remarks', 'ç„¡')}")
    try:
        requests.post("https://api.line.me/v2/bot/message/push", headers={"Authorization": f"Bearer {LINE_ACCESS_TOKEN}", "Content-Type": "application/json"}, json={"to": LINE_ADMIN_ID, "messages": [{"type": "text", "text": message}]})
    except Exception as e: print(f"LINE ç™¼é€å¤±æ•—: {e}")

# --- æ ¸å¿ƒï¼šè™•ç†è¨‚ä½ ---
def handle_booking(name, tel, email, date_str, time, pax, remarks):
    if not name or not tel or not date_str or not time:
        return "âš ï¸ è«‹å®Œæ•´å¡«å¯«å¿…å¡«æ¬„ä½ (å§“åã€é›»è©±ã€æ—¥æœŸã€æ™‚é–“)"
    
    # 1. é˜²é‡è¤‡æäº¤æ©Ÿåˆ¶
    try:
        existing = supabase.table("bookings").select("id").eq("tel", tel).eq("date", date_str).eq("time", time).neq("status", "é¡§å®¢å·²å–æ¶ˆ").execute()
        if existing.data and len(existing.data) > 0:
            return "âš ï¸ ç³»çµ±åµæ¸¬åˆ°æ‚¨å·²é ç´„éæ­¤æ™‚æ®µï¼Œè«‹å‹¿é‡è¤‡æäº¤ã€‚"
    except: pass

    data = {"name": name, "tel": tel, "email": email, "date": date_str, "time": time, "pax": pax, "remarks": remarks, "status": "å¾…è™•ç†"}
    
    try:
        supabase.table("bookings").insert(data).execute()
        send_line_notify(data)
        return """<div style='text-align: center; color: #fff; padding: 20px; border: 1px solid #d4af37; border-radius: 8px; background: #222;'><h2 style='color: #d4af37; margin: 0;'>Request Received</h2><p style='margin: 10px 0;'>ğŸ¥‚ é ç´„ç”³è«‹å·²æäº¤</p><p style='font-size: 0.9em; color: #aaa;'>ç³»çµ±å°‡ç™¼é€ç¢ºèªä¿¡è‡³æ‚¨çš„ Emailã€‚</p><p style='font-size: 0.85em; color: #ff5252; margin-top: 5px;'>(è‹¥æœªæ”¶åˆ°ï¼Œè«‹æª¢æŸ¥æ‚¨çš„<b>åƒåœ¾ä¿¡ä»¶åŒ£</b>)</p></div>"""
    except Exception as e: return f"âŒ ç³»çµ±éŒ¯èª¤: {str(e)}"

# --- æ ¸å¿ƒï¼šè™•ç†ç¢ºèª/å–æ¶ˆé€£çµ ---
def check_confirmation(request: gr.Request):
    if not request: return ""
    params = request.query_params
    action = params.get('action')
    bid = params.get('id')
    
    if action == 'confirm' and bid:
        try:
            supabase.table("bookings").update({"status": "é¡§å®¢å·²ç¢ºèª"}).eq("id", bid).execute()
            return f"""<script>document.addEventListener('DOMContentLoaded', function() {{alert('âœ… æ„Ÿè¬æ‚¨ï¼è¨‚ä½å·²ç¢ºèª (ç·¨è™Ÿ {bid})');}});</script><div style='padding:20px; background:#d4af37; color:black; text-align:center; margin-bottom:20px; border-radius:8px; font-weight:bold;'>ğŸ‰ æ„Ÿè¬æ‚¨çš„ç¢ºèªï¼æˆ‘å€‘æœŸå¾…æ‚¨çš„å…‰è‡¨ã€‚ (è¨‚å–®ç·¨è™Ÿ: {bid})</div>"""
        except: return ""

    elif action == 'cancel' and bid:
        try:
            supabase.table("bookings").update({"status": "é¡§å®¢å·²å–æ¶ˆ"}).eq("id", bid).execute()
            return f"""<script>document.addEventListener('DOMContentLoaded', function() {{alert('å·²ç‚ºæ‚¨å–æ¶ˆè¨‚ä½ (ç·¨è™Ÿ {bid})');}});</script><div style='padding:20px; background:#333; border: 1px solid #ff5252; color:#ff5252; text-align:center; margin-bottom:20px; border-radius:8px;'>ğŸš« è¨‚ä½å·²å–æ¶ˆã€‚<br>æœŸå¾…æ‚¨ä¸‹æ¬¡æœ‰æ©Ÿæœƒå†ä¾†è¨ªã€‚</div>"""
        except: return ""
    return ""

# --- ä»‹é¢ ---
theme = gr.themes.Soft(primary_hue="amber", neutral_hue="zinc").set(body_background_fill="#0F0F0F", block_background_fill="#1a1a1a", block_border_width="1px", block_border_color="#333", input_background_fill="#262626", input_border_color="#444", body_text_color="#E0E0E0", block_title_text_color="#d4af37", button_primary_background_fill="#d4af37", button_primary_text_color="#000000")
custom_css = "footer {display: none !important;} .gradio-container, .block, .row, .column { overflow: visible !important; } .options, .wrap .options { background-color: #262626 !important; border: 1px solid #d4af37 !important; z-index: 10000 !important; } .item:hover, .options .item:hover { background-color: #d4af37 !important; color: black !important; } .legal-footer { text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; color: #666; font-size: 0.75rem; }"

with gr.Blocks(theme=theme, css=custom_css, title="Booking") as demo:
    confirm_msg_box = gr.HTML()
    demo.load(check_confirmation, inputs=None, outputs=confirm_msg_box)

    with gr.Row():
        with gr.Column():
            gr.Markdown("### ğŸ“… é ç´„è³‡è¨Š Booking Info")
            date_options = get_date_options()
            booking_date = gr.Dropdown(choices=date_options, label="é¸æ“‡æ—¥æœŸ Select Date", interactive=True)
            pax_count = gr.Slider(minimum=1, maximum=10, value=2, step=1, label="ç”¨é¤äººæ•¸ Guest Count")
        with gr.Column():
             gr.Markdown("### ğŸ•°ï¸ é¸æ“‡æ™‚æ®µ Time Slot")
             status_box = gr.Markdown("è«‹å…ˆé¸æ“‡æ—¥æœŸ...", visible=True)
             time_slot = gr.Dropdown(choices=[], label="å¯ç”¨æ™‚æ®µ Available Time", interactive=True)
    gr.HTML("<div style='height: 10px'></div>")
    gr.Markdown("### ğŸ‘¤ è¯çµ¡äººè³‡æ–™ Contact")
    with gr.Group():
        with gr.Row():
            cust_name = gr.Textbox(label="è¨‚ä½å§“å Name *", placeholder="ex. ç‹å°æ˜")
            cust_tel = gr.Textbox(label="æ‰‹æ©Ÿè™Ÿç¢¼ Phone *", placeholder="ex. 0912-xxx-xxx")
        with gr.Row():
            cust_email = gr.Textbox(label="é›»å­ä¿¡ç®± Email (æ¥æ”¶ç¢ºèªä¿¡ç”¨)", placeholder="example@gmail.com")
        with gr.Row():
            cust_remarks = gr.Textbox(label="å‚™è¨» Remarks", lines=2)
    gr.HTML("<div style='height: 15px'></div>")
    submit_btn = gr.Button("ç¢ºèªé ç´„ Request Booking", size="lg", variant="primary")
    output_msg = gr.HTML()
    gr.HTML("""<div class="legal-footer"><p style="margin-bottom: 5px;">Â© 2026 CIE CIE TAIPEI. All Rights Reserved.</p><p>å…§å®¹æ¶‰åŠé…’é¡ç”¢å“è¨Šæ¯ï¼Œè«‹å‹¿è½‰ç™¼åˆ†äº«çµ¦æœªé”æ³•å®šè³¼è²·å¹´é½¡è€…ï¼›æœªæ»¿åå…«æ­²è«‹å‹¿é£²é…’ã€‚<br><strong>å–é…’ä¸é–‹è»Šï¼Œé–‹è»Šä¸å–é…’ã€‚</strong></p></div>""")

    booking_date.change(update_time_slots, inputs=booking_date, outputs=[time_slot, status_box])
    submit_btn.click(handle_booking, inputs=[cust_name, cust_tel, cust_email, booking_date, time_slot, pax_count, cust_remarks], outputs=output_msg)

if __name__ == "__main__":
    demo.launch()

```

---

## ğŸ› ï¸ ç¬¬å››æ­¥ï¼šSpace B (è€é—†å¾Œå°ç®¡ç†)

**è² è²¬ï¼š** æŸ¥çœ‹æ¸…å–®ã€ç”¢ç”Ÿé›™æŒ‰éˆ•ä¿¡ä»¶å…§å®¹ã€é€é GAS å¯„ä¿¡ã€å¸³è™Ÿé©—è­‰ã€‚

1. **Hugging Face è¨­å®šï¼š**
* Visibility: **Public** (ä¾é ç¨‹å¼ç¢¼çš„ `auth` ä¿è­·)ã€‚
* **Secrets:** `SUPABASE_URL`, `SUPABASE_KEY`, `GAS_MAIL_URL`, `ADMIN_USER`, `ADMIN_PASSWORD`
* âš ï¸ **æ³¨æ„ï¼š** `app.py` è£¡çš„ `PUBLIC_SPACE_URL` å¿…é ˆæ”¹æˆæ‚¨ **Space A** çš„ç¶²å€ã€‚


2. **Files > requirements.txt:**
```text
gradio
supabase
pandas
requests

```


3. **Files > app.py (å®Œæ•´æœ€çµ‚ç‰ˆ):**

```python
import gradio as gr
import os
import pandas as pd
import requests
from supabase import create_client, Client
from datetime import datetime, timedelta, timezone

# --- è¨­å®š ---
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
GAS_MAIL_URL = os.getenv("GAS_MAIL_URL")
# âš ï¸ è«‹å¡«å…¥ Space A çš„ç¶²å€ (Direct URL æˆ– HuggingFace Page URL çš†å¯ï¼Œå»ºè­°ç”¨ Direct URL)
PUBLIC_SPACE_URL = "https://deeplearning101-ciecietaipei.hf.space"

supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
ADMIN_USER = os.getenv("ADMIN_USER")
ADMIN_PASSWORD = os.getenv("ADMIN_PASSWORD")

def get_bookings():
    response = supabase.table("bookings").select("*").order("created_at", desc=True).execute()
    if not response.data: return pd.DataFrame()
    df = pd.DataFrame(response.data)
    cols = ['id', 'date', 'time', 'name', 'tel', 'email', 'pax', 'remarks', 'status']
    for c in cols:
        if c not in df.columns: df[c] = ""
    return df[cols]

def send_confirmation_email(booking_id):
    try:
        if not GAS_MAIL_URL: return "âŒ éŒ¯èª¤ï¼šæœªè¨­å®š GAS_MAIL_URL"
        res = supabase.table("bookings").select("*").eq("id", booking_id).execute()
        if not res.data: return "âŒ æ‰¾ä¸åˆ°è©²è¨‚å–®"
        booking = res.data[0]
        email = booking.get('email')
        if not email or "@" not in email: return "âŒ ç„¡æ•ˆ Email"

        # ç”¢ç”Ÿé›™é€£çµ
        confirm_link = f"{PUBLIC_SPACE_URL}/?id={booking_id}&action=confirm"
        cancel_link = f"{PUBLIC_SPACE_URL}/?id={booking_id}&action=cancel"

        html_content = f"""
        <div style="padding: 20px; background: #111; color: #d4af37; font-family: sans-serif; border-radius: 10px; max-width: 600px; margin: 0 auto;">
            <h2 style="border-bottom: 1px solid #d4af37; padding-bottom: 15px; text-align: center;">CiÃ© CiÃ© Taipei</h2>
            <p style="font-size: 16px; margin-top: 20px;">{booking['name']} æ‚¨å¥½ï¼Œæˆ‘å€‘å·²ç‚ºæ‚¨ä¿ç•™åº§ä½ï¼š</p>
            <div style="background: #222; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #d4af37;">
                <ul style="color: #eee; list-style: none; padding: 0;">
                    <li>ğŸ“… <b>æ—¥æœŸï¼š</b> {booking['date']}</li>
                    <li>â° <b>æ™‚é–“ï¼š</b> {booking['time']}</li>
                    <li>ğŸ‘¥ <b>äººæ•¸ï¼š</b> {booking['pax']} ä½</li>
                    <li>ğŸ“ <b>å‚™è¨»ï¼š</b> {booking.get('remarks') or 'ç„¡'}</li>
                </ul>
            </div>
            <p style="text-align: center; font-weight: bold; color: #fff;">è«‹é¸æ“‡æ‚¨çš„å›è¦†ï¼š</p>
            <div style="text-align: center; margin-bottom: 30px;">
                <a href="{confirm_link}" style="display: inline-block; background: #d4af37; color: #000; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 0 10px;">âœ… ç¢ºèªå‡ºå¸­</a>
                <a href="{cancel_link}" style="display: inline-block; border: 1px solid #ff5252; color: #ff5252; padding: 11px 29px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 0 10px;">ğŸš« å–æ¶ˆè¨‚ä½</a>
            </div>
            <hr style="border: 0; border-top: 1px solid #333;">
            <p style="color: #666; font-size: 12px; text-align: center;">æ­¤ç‚ºç³»çµ±è‡ªå‹•ç™¼é€ï¼Œå¦‚éœ€äººå·¥æœå‹™è«‹è‡´é›»ã€‚</p>
        </div>
        """
        payload = {"to": email, "subject": f"[{booking['date']}] CiÃ© CiÃ© Taipei è¨‚ä½ç¢ºèªä¿¡", "htmlBody": html_content, "name": "CiÃ© CiÃ© Taipei"}
        requests.post(GAS_MAIL_URL, json=payload)
        supabase.table("bookings").update({"status": "å·²ç™¼ç¢ºèªä¿¡"}).eq("id", booking_id).execute()
        return f"âœ… å·²é€é GAS ç™¼é€ç¢ºèªä¿¡çµ¦ {booking['name']}"
    except Exception as e: return f"âŒ ç™¼ä¿¡å¤±æ•—: {str(e)}"

with gr.Blocks(title="Admin") as demo:
    gr.Markdown("# ğŸ· è¨‚ä½ç®¡ç†å¾Œå°")
    refresh_btn = gr.Button("ğŸ”„ é‡æ–°æ•´ç†")
    booking_table = gr.Dataframe(interactive=False)
    with gr.Row():
        id_input = gr.Number(label="è¨‚å–® ID", precision=0)
        action_btn = gr.Button("ğŸ“§ ç™¼é€ç¢ºèªä¿¡ (Send Email)", variant="primary")
    log_output = gr.Textbox(label="åŸ·è¡Œçµæœ")
    refresh_btn.click(get_bookings, outputs=booking_table)
    action_btn.click(send_confirmation_email, inputs=id_input, outputs=log_output)

if __name__ == "__main__":
    user = ADMIN_USER if ADMIN_USER else "admin"
    pwd = ADMIN_PASSWORD if ADMIN_PASSWORD else "123456"
    demo.launch(auth=(user, pwd))

```

---

## ğŸ“± ç¬¬äº”æ­¥ï¼šGitHub Pages (ç¶²ç«™æ•´åˆ)

é€™ä¸€æ­¥æœ€é—œéµçš„æ˜¯ **iOS æ»‘å‹•å„ªåŒ–**ï¼Œæˆ‘åœ¨ CSS ä¸­åŠ å…¥äº† `-webkit-overflow-scrolling: touch`ã€‚

### 1. `booking.html` (é¡§å®¢è¨‚ä½é )

* **é—œéµä¿®æ”¹ï¼š** CSS åŠ å…¥äº†é‡å° iOS çš„å„ªåŒ–ï¼Œé¿å…é›™å·è»¸å¡ä½ã€‚
* **ä½¿ç”¨æ–¹å¼ï¼š** å°‡ `iframe src` æ›æˆæ‚¨ **Space A** çš„ç¶²å€ (çµå°¾åŠ  `?__theme=dark`)ã€‚

```html
.booking-section {
    /* ...åŸæœ‰è¨­å®š... */
    -webkit-overflow-scrolling: touch; /* iOS æ»‘å‹•é †æš¢é—œéµ */
    overflow-y: auto;
}
#booking-frame {
    width: 1px;
    min-width: 100%;
    height: 1000px; /* çµ¦äºˆè¶³å¤ é«˜åº¦ï¼Œé¿å…å…§éƒ¨å·è»¸ */
    border: none;
}

```

### 2. `admin.html` (å¾Œå°ç®¡ç†é )

* **é—œéµä¿®æ”¹ï¼š** ä½¿ç”¨èˆ‡å‰å°ä¸€è‡´çš„é»‘é‡‘é¢¨æ ¼ï¼Œå®¹å™¨åŠ å¯¬ä»¥å®¹ç´è¡¨æ ¼ã€‚
* **ä½¿ç”¨æ–¹å¼ï¼š** å°‡ `iframe src` æ›æˆæ‚¨ **Space B** çš„ç¶²å€ (çµå°¾åŠ  `?__theme=dark`)ã€‚

---

## âš ï¸ é‡è¦ç¶­é‹æª¢æŸ¥è¡¨ (Checklist)

1. **7 å¤©æš«åœæ©Ÿåˆ¶ï¼š** æ¯é€±å‹™å¿…ç™»å…¥ä¸€æ¬¡ `admin.html` æˆ– Space B å¾Œå°ï¼Œé˜²æ­¢ Supabase å› é–’ç½®è€Œæš«åœã€‚
2. **æ™‚å€ç¢ºèªï¼š** ç¨‹å¼ç¢¼ä¸­å·²åŠ å…¥ `TAIPEI_TZ`ï¼Œç¢ºä¿æ›æ—¥æ™‚é–“æ­£ç¢º (ä¸æœƒç™¼ç”Ÿæ—©ä¸Šè¨‚ä¸åˆ°ä»Šæ™šçš„æƒ…æ³)ã€‚
3. **åƒåœ¾ä¿¡æé†’ï¼š** `booking.html` çš„æˆåŠŸè¨Šæ¯å·²åŠ å…¥ç´…è‰²æé†’æ–‡å­—ï¼Œè«‹å®¢äººæª¢æŸ¥åƒåœ¾ä¿¡ä»¶åŒ£ã€‚
4. **å–æ¶ˆåŠŸèƒ½æ¸¬è©¦ï¼š** å»ºè­°æ‚¨è‡ªå·±è·‘ä¸€æ¬¡æµç¨‹ï¼šå‰å°è¨‚ä½ -> å¾Œå°ç™¼ä¿¡ -> æ”¶ä¿¡é»æ“Šå–æ¶ˆ -> ç¢ºèªç‹€æ…‹è®Šæ›´ã€‚

ğŸ‰ **æ­å–œï¼æ‚¨ç¾åœ¨æ“æœ‰ä¸€å¥—åŠŸèƒ½å®Œæ•´ã€é«”é©—æµæš¢ä¸”å®Œå…¨å…è²»çš„è‡ªå‹•åŒ–è¨‚ä½ç³»çµ±ã€‚**

// ======================================================
// å…¨åŸŸè¨­å®šå€ (è«‹å‹™å¿…ä¿®æ”¹)
// ======================================================

// 1. LINE Channel Access Token (è«‹å¡«å…¥æ‚¨çš„ Token)
const CHANNEL_ACCESS_TOKEN = "";

// 2. Google Sheet ID (è«‹å¡«å…¥æ‚¨çš„è©¦ç®—è¡¨ ID)
const SHEET_ID = "";

// 3. Web App ç¶²å€ (éƒ¨ç½²å¾Œå–å¾—çš„ç¶²å€ï¼Œè«‹å¡«å…¥)
const WEB_APP_URL = "";

// 4. âš ï¸ ä¿®æ­£ï¼šæ–°å¢ç®¡ç†å“¡ User ID
const ADMIN_USER_ID = ""; // è«‹å¡«å…¥ä½ çš„ LINE User ID (Ué–‹é ­)


// ======================================================
// æ ¸å¿ƒç¨‹å¼ç¢¼é–‹å§‹
// ======================================================

const ss = SpreadsheetApp.openById(SHEET_ID);
var sheet = ss.getSheetByName("è¡¨å–®å›æ‡‰ 1");
if (!sheet) sheet = ss.getSheets()[0];

// ------------------------------------------------------
// åŠŸèƒ½ 1ï¼šç•¶æœ‰æ–°è¨‚ä½ (Google Form æäº¤) æ™‚è§¸ç™¼
// ------------------------------------------------------
function onFormSubmit(e) {
  var lastRow = sheet.getLastRow();
  
  // 1. è‡ªå‹•ç”¢ç”Ÿè¨‚ä½ç·¨è™Ÿ (ID)
  var uniqueId = "R-" + Math.random().toString(36).substr(2, 5).toUpperCase();
  
  // 2. æŠŠ ID å¯«å…¥ A æ¬„ (ç¬¬ 1 æ¬„)
  sheet.getRange(lastRow, 1).setValue(uniqueId);
  
  // 3. æŠŠç‹€æ…‹é è¨­ç‚º "å¾…è™•ç†" å¯«å…¥ J æ¬„ (ç¬¬ 10 æ¬„)
  sheet.getRange(lastRow, 10).setValue("å¾…è™•ç†");

  // 4. å–å¾—è¨‚ä½è³‡è¨Š (ç™¼é€ LINE é€šçŸ¥ç”¨)
  var rowData = sheet.getRange(lastRow, 1, 1, 12).getValues()[0];
  
// âš ï¸ ä¿®æ­£æ¬„ä½å°æ‡‰ Index (A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7)
  var customerName = rowData[2]; // Cæ¬„ (è¨‚ä½å§“å)
  var tel = rowData[3];          // Dæ¬„ (è¯çµ¡é›»è©±)
  var dateRaw = rowData[5];      // Fæ¬„ (è¨‚ä½æ—¥æœŸ)
  var timeRaw = rowData[6];      // Gæ¬„ (è¨‚ä½æ™‚é–“)
  var pax = rowData[7];          // Hæ¬„ (ç”¨é¤äººæ•¸)
  
  
  // 1. æ ¼å¼åŒ–æ—¥æœŸ
  var dateStr = "";
  if (dateRaw) {
    if (typeof dateRaw === 'object') {
      dateStr = Utilities.formatDate(new Date(dateRaw), "GMT+8", "yyyy/MM/dd");
    } else {
      dateStr = dateRaw.toString().substring(0, 10);
    }
  }

  // 2. æ ¼å¼åŒ–æ™‚é–“ (HH:mm)
  var timeStr = "";
  if (timeRaw) {
    if (typeof timeRaw === 'object') {
      // ç¢ºä¿æ˜¯æ—¥æœŸç‰©ä»¶ï¼Œåªå–å‡º HH:mm
      timeStr = Utilities.formatDate(new Date(timeRaw), "GMT+8", "HH:mm");
    } else {
      timeStr = timeRaw.toString();
    }
  }
  
  var msg = "ğŸ”” CIECIE Taipei æ–°è¨‚ä½é€šçŸ¥ï¼\n" + 
            "ç·¨è™Ÿï¼š" + uniqueId + "\n" +
            "å§“åï¼š" + customerName + "\n" + 
            "é›»è©±ï¼š" + tel + "\n" +
            "æ™‚é–“ï¼š" + dateStr + " " + timeStr + "\n" + 
            "äººæ•¸ï¼š" + pax + "\n" +
            "ç‹€æ…‹ï¼šå¾…è™•ç†";
            
  pushLineMessage(msg, ADMIN_USER_ID);
}

// ------------------------------------------------------
// åŠŸèƒ½ 2ï¼šç•¶åº—å®¶æ‰‹å‹•æ›´æ”¹ç‹€æ…‹æ™‚ (å¯„é€ç¢ºèªä¿¡) - å¼·åŒ–åµéŒ¯ç‰ˆ
// ------------------------------------------------------
function sendEmailOnEdit(e) {
  if (!e || !e.value) {
    Logger.log("âŒ åŸ·è¡Œå¤±æ•—ï¼šä¸æ˜¯æ‰‹å‹•ç·¨è¼¯æˆ–ç¼ºå°‘ e.value");
    return;
  }
  
  const ss = SpreadsheetApp.getActiveSpreadsheet(); // åœ¨ On Edit ç’°å¢ƒä¸­é€™æ¨£æŠ“
  var range = e.range;
  var currentSheet = range.getSheet();
  var row = range.getRow();
  var col = range.getColumn();
  var val = e.value;
  var sheetName = currentSheet.getName();

  // 1. æª¢æŸ¥åˆ†é 
  if (sheetName.indexOf("è¡¨å–®") === -1 && sheetName.indexOf("Form") === -1) {
    return;
  }
  
  // å–å¾—ç¬¬ä¸€åˆ—æ‰€æœ‰çš„æ¨™é¡Œ
  var lastCol = currentSheet.getLastColumn();
  var headers = currentSheet.getRange(1, 1, 1, lastCol).getValues()[0];

  // è‡ªå‹•å°‹æ‰¾æ¬„ä½ä½ç½® (æ¨¡ç³Šæœå°‹)
  var statusIndex = headers.findIndex(h => h.toString().indexOf("è¨‚ä½ç‹€æ…‹") > -1);
  var emailIndex = headers.findIndex(h => h.toString().indexOf("Email") > -1);
  var nameIndex = headers.findIndex(h => h.toString().indexOf("å§“å") > -1);
  var idIndex = headers.findIndex(h => h.toString().indexOf("ç·¨è™Ÿ") > -1);

  // ç´€éŒ„åµéŒ¯è³‡è¨Š (é—œéµï¼)
  Logger.log("--- åµéŒ¯æª¢æŸ¥é–‹å§‹ ---");
  Logger.log(`1. ç·¨è¼¯çš„åˆ—/æ¬„: ${row}/${col}`);
  Logger.log(`2. ç‹€æ…‹æ¬„ä½ Index (0-based): ${statusIndex}`);
  Logger.log(`3. ç‹€æ…‹æ¬„ä½æ‡‰ç‚º: ${statusIndex + 1} (1-based)`);
  Logger.log(`4. ç·¨è¼¯å¾Œçš„å€¼: "${val}"`);

  // 4. æª¢æŸ¥æ˜¯å¦è§¸ç™¼ï¼šç·¨è¼¯çš„æ¬„ä½å¿…é ˆæ˜¯ã€Œç‹€æ…‹æ¬„ã€ ä¸” å€¼ç‚ºã€Œç™¼é€ç¢ºèªä¿¡ã€
  // (statusIndex æ˜¯å¾ 0 é–‹å§‹ç®—ï¼Œä½† col æ˜¯å¾ 1 é–‹å§‹ç®—ï¼Œæ‰€ä»¥è¦ +1)
  if (col === (statusIndex + 1) && val === "ç™¼é€ç¢ºèªä¿¡" && row > 1) {
    Logger.log("âœ… è§¸ç™¼æ¢ä»¶é€šéï¼æº–å‚™ç™¼ä¿¡ã€‚");
    
    // å–å¾—è©²åˆ—è³‡æ–™
    var data = currentSheet.getRange(row, 1, 1, lastCol).getValues()[0];

    // ğŸ¯ é—œéµï¼šä½¿ç”¨è‡ªå‹•æ‰¾åˆ°çš„ Index ä¾†æŠ“è³‡æ–™
    var bookingId = (idIndex > -1) ? data[idIndex] : "Unknown";
    var customerName = (nameIndex > -1) ? data[nameIndex] : "è²´è³“";
    var customerEmail = data[emailIndex]; 

    Logger.log("5. æŠ“åˆ°çš„ Email: " + customerEmail);

    // æª¢æŸ¥ Email æ ¼å¼
    if (!customerEmail || customerEmail.toString().indexOf("@") === -1) {
      ss.toast("âŒ Email æ ¼å¼éŒ¯èª¤ï¼ŒæŠ“åˆ°çš„è³‡æ–™æ˜¯ï¼š" + customerEmail);
      Logger.log("âŒ Email æ ¼å¼éŒ¯èª¤ï¼Œä¸­æ–·ç™¼ä¿¡ã€‚");
      return;
    }

    // æº–å‚™å¯„ä¿¡ (ä½¿ç”¨ä½ åŸæœ¬çš„é‚è¼¯)
    var confirmLink = WEB_APP_URL + "?action=confirm&id=" + bookingId;
    var subject = "[CiÃ© CiÃ© Taipei] è¨‚ä½ä¿ç•™ç¢ºèªé€šçŸ¥";
    var body = "<h3>" + customerName + " æ‚¨å¥½ï¼Œ</h3>" +
               "<p>æ„Ÿè¬æ‚¨çš„é ç´„ï¼Œåº§ä½ç‚ºæ‚¨ä¿ç•™ä¸­ï¼Œè«‹é»æ“Šä¸‹æ–¹é€£çµç¢ºèªå‡ºå¸­ï¼š</p>" +
               "<br>" +
               "<a href='" + confirmLink + "' style='background-color:#BFA46F; color:white; padding:12px 24px; text-decoration:none; border-radius:4px;'>ç¢ºèªå‡ºå¸­</a>";

    try {
      MailApp.sendEmail({to: customerEmail, subject: subject, htmlBody: body});
      ss.toast("âœ… å·²å¯„å‡ºç¢ºèªä¿¡çµ¦ " + customerName);
      Logger.log("ğŸ‰ éƒµä»¶æˆåŠŸç™¼é€çµ¦: " + customerEmail);
    } catch (err) {
      ss.toast("âŒ å¯„ä¿¡å¤±æ•—ï¼š" + err.message);
      Logger.log("âŒ MailApp å´©æ½°: " + err.message);
    }
  } else {
    Logger.log("âŒ è§¸ç™¼æ¢ä»¶æœªé€šéã€‚ (å¯èƒ½ä¸æ˜¯ç‹€æ…‹æ¬„ï¼Œæˆ–å€¼ä¸ç‚ºã€ç™¼é€ç¢ºèªä¿¡ã€)");
  }
}


// ------------------------------------------------------
// åŠŸèƒ½ 3ï¼šè™•ç†å®¢äººé»æ“Šé€£çµ (Web App)
// ------------------------------------------------------
function doGet(e) {
  if (!e || !e.parameter) return HtmlService.createHtmlOutput("ç„¡æ•ˆçš„è«‹æ±‚");
  
  var action = e.parameter.action;
  var id = e.parameter.id;
  
  if (action == "confirm" && id) {
    return confirmBooking(id);
  } else {
    return HtmlService.createHtmlOutput("<h1>é€£çµç„¡æ•ˆæˆ–åƒæ•¸éŒ¯èª¤</h1>");
  }
}

// ------------------------------------------------------
// åŠŸèƒ½ 3ï¼šè™•ç†å®¢äººé»æ“Šé€£çµ (Web App) (å·²ä¿®æ­£é˜²é‡è¤‡ç™¼é€)
// ------------------------------------------------------
function confirmBooking(targetId) {
  var data = sheet.getDataRange().getValues();
  var rowIndex = -1;
  var statusColIndex = 9; // ç‹€æ…‹æ¬„ä½ J æ¬„ (ç´¢å¼• 9)
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] == targetId) {
      rowIndex = i + 1;
      break;
    }
  }
  
  if (rowIndex > 0) {
    // å–å¾—ç•¶å‰ç‹€æ…‹
    var currentStatus = sheet.getRange(rowIndex, statusColIndex + 1).getValue().toString();
    
    // æª¢æŸ¥å®ˆè¡›ï¼šå¦‚æœç‹€æ…‹å·²ç¶“æ˜¯ã€Œå®¢æˆ¶å·²ç¢ºèªã€ï¼Œå‰‡ä¸åŸ·è¡Œå¯«å…¥å’Œç™¼é€è¨Šæ¯
    if (currentStatus === "å®¢æˆ¶å·²ç¢ºèª") {
        // ç›´æ¥å›å‚³æˆåŠŸç¶²é ï¼Œé¿å…é‡è¤‡æ“ä½œ
        return HtmlService.createHtmlOutput("<h1>è¨‚ä½å·²ç¢ºèªï¼Œç„¡éœ€é‡è¤‡æ“ä½œã€‚</h1>").setTitle("è¨‚ä½å·²ç¢ºèª");
    }

    // ç‹€æ…‹å¯«å…¥ã€Œå®¢æˆ¶å·²ç¢ºèªã€
    sheet.getRange(rowIndex, 10).setValue("å®¢æˆ¶å·²ç¢ºèª");
    sheet.getRange(rowIndex, 1, 1, 10).setBackground("#E6F4EA");
    
    // 3. å–å¾—è³‡è¨Šé€šçŸ¥åº—å®¶ (LINE)
    var rowData = sheet.getRange(rowIndex, 1, 1, 12).getValues()[0];
    
    // âš ï¸ ä¿®æ­£æ¬„ä½å°æ‡‰ Index (ç•¥éé‡è¤‡ä»£ç¢¼ï¼Œç¢ºä¿é‚è¼¯æ­£ç¢º)
    var name = rowData[2]; 
    var tel = rowData[3]; 
    var dateRaw = rowData[5]; 
    var timeRaw = rowData[6]; 
    
    var dateStr = Utilities.formatDate(new Date(dateRaw), "GMT+8", "MM/dd");
    
    var timeStr = "";
    if (timeRaw) {
      if (typeof timeRaw === 'object') {
        timeStr = Utilities.formatDate(new Date(timeRaw), "GMT+8", "HH:mm");
      } else {
        timeStr = timeRaw.toString();
      }
    }

    var confirmMsg = "âœ… è¨‚ä½æˆç«‹ (å®¢äººå·²æŒ‰ç¢ºèª)ï¼\n" +
                      "ç·¨è™Ÿï¼š" + targetId + "\n" +
                      "å§“åï¼š" + name + "\n" +
                      "é›»è©±ï¼š" + tel + "\n" +
                      "æ™‚é–“ï¼š" + dateStr + " " + timeStr;
                      
    pushLineMessage(confirmMsg, ADMIN_USER_ID); // <-- é€™è£¡åªæœƒç™¼é€ä¸€æ¬¡ï¼
    
    // 4. å›å‚³ç¶²é çµ¦å®¢äºº
    var html =  
      "<html><head><meta name='viewport' content='width=device-width, initial-scale=1'></head>" +
      "<body style='text-align:center; font-family: sans-serif; padding: 40px 20px; background-color: #f9f9f9;'>" +
        "<div style='background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto;'>" +
          "<h1 style='color:#4CAF50;'>è¨‚ä½ç¢ºèªæˆåŠŸï¼</h1>" +
          "<p>æ„Ÿè¬æ‚¨ï¼ŒCiÃ© CiÃ© Taipei æœŸå¾…æ‚¨çš„å…‰è‡¨ã€‚</p>" +
        "</div>" +
      "</body></html>";
    return HtmlService.createHtmlOutput(html).setTitle("è¨‚ä½ç¢ºèªæˆåŠŸ");
    
  } else {
    return HtmlService.createHtmlOutput("<h1>æ‰¾ä¸åˆ°æ­¤è¨‚ä½ï¼Œå¯èƒ½å·²è¢«åˆªé™¤æˆ–éæœŸã€‚</h1>");
  }
}

// ------------------------------------------------------
// å·¥å…·ï¼šç™¼é€ LINE Message (Push åˆ°æŒ‡å®š User ID)
// ------------------------------------------------------
function pushLineMessage(msg, targetUserId) {
  // âš ï¸ ä¿®æ­£ï¼šæ”¹ç”¨ push API
  var url = "https://api.line.me/v2/bot/message/push"; 
  
  var payload = {
    // âš ï¸ ä¿®æ­£ï¼šPush API å¿…é ˆæŒ‡å®š to (æ¥æ”¶è€…)
    "to": targetUserId, 
    "messages": [
      {
        "type": "text",
        "text": msg
      }
    ]
  };
  
  var options = {
    "method": "post",
    "headers": {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN
    },
    "payload": JSON.stringify(payload),
    "muteHttpExceptions": true
  };
  
  try {
    var response = UrlFetchApp.fetch(url, options);
    Logger.log("LINE Push Response: " + response.getContentText());
  } catch (e) {
    Logger.log("LINE Error: " + e.toString());
  }
}

/**
 * âš ï¸ è‡¨æ™‚å‡½å¼ï¼šç”¨ä¾†æ•æ‰ Admin User ID
 * æ­¥é©Ÿï¼š
 * 1. éƒ¨ç½²æ­¤å‡½å¼ä¸¦å–å¾— Webhook URLã€‚
 * 2. å°‡æ­¤ URL è²¼åˆ° LINE Developers å¾Œå°ï¼ˆAdmin Channelï¼‰ã€‚
 * 3. ç®¡ç†è€…å‚³é€ä¸€å€‹è¨Šæ¯çµ¦ LINE Botã€‚
 * 4. æª¢æŸ¥ Apps Script çš„ã€ŒåŸ·è¡Œé …ç›®ã€æˆ–ã€Œè¨˜éŒ„ã€å³å¯æ‰¾åˆ° IDã€‚
 */
function getMyAdminUserID(e) {
  try {
    var postData = JSON.parse(e.postData.contents);
    // é€™ä¸€è¡Œæœƒå°‡æ•´å€‹ LINE å‚³é€çš„ JSON å…§å®¹è¨˜éŒ„ä¸‹ä¾†
    // User ID æœƒåœ¨ postData.events[0].source.userId è£¡é¢
    Logger.log("ğŸ‰ æ•æ‰åˆ° LINE Webhook è³‡è¨Š: " + JSON.stringify(postData)); 
    
    // å˜—è©¦ç›´æ¥è¼¸å‡º User ID åˆ° Log
    if (postData.events && postData.events.length > 0) {
      var userId = postData.events[0].source.userId;
      Logger.log("ğŸ¯ ä½ çš„ User ID æ˜¯: " + userId);
    }
    
    // å¿…é ˆå›å‚³ 200 OK
    return ContentService.createTextOutput(JSON.stringify({status: 'ok'})).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log("âŒ æ¥æ”¶å¤±æ•—: " + err.toString());
    return ContentService.createTextOutput("Error");
  }
}

function sendTestEmailForAuth() {
  // âš ï¸ è«‹å°‡é€™è£¡æ›¿æ›æˆä½ ç¢ºå®šèƒ½æ”¶åˆ°ä¿¡çš„ Email åœ°å€ï¼ˆä¾‹å¦‚ä½ çš„ Gmail æˆ–å…¬å¸ä¿¡ç®±ï¼‰
  const targetEmail = "mobileariva@gmail.com"; 
  const subjectText = "âœ… Google Apps Script æˆæ¬Šæ¸¬è©¦ (ç¬¬äºŒæ¬¡)";
  
  Logger.log("ğŸ¯ æº–å‚™ç™¼é€æ¸¬è©¦ä¿¡çµ¦: " + targetEmail);

  try {
    MailApp.sendEmail({
      to: targetEmail,
      subject: subjectText,
      body: "é€™å°ä¿¡æ˜¯ç”¨ä¾†æª¢æŸ¥ MailApp æ¬Šé™æ˜¯å¦æ­£ç¢ºæˆæ¬Šçš„ã€‚æ”¶åˆ°å³è¡¨ç¤ºæˆæ¬ŠæˆåŠŸï¼"
    });
    Logger.log("ğŸ‰ æ¸¬è©¦ä¿¡ç™¼é€æˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±ã€‚");
  } catch(e) {
    Logger.log("âŒ æˆæ¬Šæ¸¬è©¦å¤±æ•—: " + e.toString());
  }
}

// ------------------------------------------------------
// å‡½å¼ï¼šLINE Webhook æ¥æ”¶å™¨ (ç”¨æ–¼é˜»æ­¢é‡è©¦è¿´åœˆ)
// ------------------------------------------------------
function doPost(e) {
  // æ”¶åˆ° LINE çš„è¨Šæ¯ï¼Œä½†æˆ‘å€‘ä¸éœ€è¦è™•ç†å®ƒï¼Œåªéœ€è¦å‘Šè¨´ LINE æˆåŠŸæ”¶åˆ°äº† (200 OK)
  return ContentService.createTextOutput().setMimeType(ContentService.MimeType.TEXT);
}










































/**
 * =========================================================
 * é¤å»³è¨‚ä½ç³»çµ± - é›™é€šé“çµæ§‹ (Customer Channel A / Admin Channel B)
 * =========================================================
 */

// â–¼â–¼â–¼ è¨­å®šå€ï¼šè«‹å¡«å…¥ä½ çš„å…©å€‹é€šé“ Token â–¼â–¼â–¼
// âš ï¸ é€šé“ B: ç®¡ç†è€…/é€šçŸ¥å¸³è™Ÿçš„ Token (Web App çš„ Webhook ä¹Ÿæ‡‰è©²è¨­åœ¨é€™è£¡)
// const ADMIN_CHANNEL_TOKEN = 'è«‹å¡«å…¥_Bot_B_è€é—†é€šçŸ¥ç”¨çš„_Token'; 
const ADMIN_CHANNEL_TOKEN = '';


// âš ï¸ é€šé“ A: é¡§å®¢è¨‚ä½å®˜æ–¹å¸³è™Ÿçš„ Token (ç”¨æ–¼æ¨æ’­çµ¦é¡§å®¢)
// const CUSTOMER_CHANNEL_TOKEN = 'è«‹å¡«å…¥_Bot_A_åŸæœ¬èˆŠå¸³è™Ÿçš„_Token';
const CUSTOMER_CHANNEL_TOKEN = '';

// âš ï¸ ç®¡ç†è€… User ID (æ¥æ”¶é€šçŸ¥çš„è€é—† ID)
// const ADMIN_USER_ID = 'è«‹å¡«å…¥_è€é—†ä½ çš„_User_ID'; 
const ADMIN_USER_ID = '';
// â–²â–²â–² è¨­å®šçµæŸ â–²â–²â–²

// ---------------------------------------------------------
// ä¸»å‡½å¼ (ä¸è®Š)
// ---------------------------------------------------------

function doPost(e) {
  console.error("ğŸ”¥ æ”¶åˆ°è¨Šè™Ÿäº†ï¼åƒæ•¸ e: " + JSON.stringify(e));

  let postData;
  try {
    postData = JSON.parse(e.postData.contents);
    console.log("Log 2: æ”¶åˆ°è³‡æ–™: " + JSON.stringify(postData)); 
  } catch (err) {
    console.log("JSON è§£æå¤±æ•—: " + err.toString());
    return ContentService.createTextOutput("JSON Error");
  }

  if (postData.type === 'new_booking') {
    console.log("Log 3: é€²å…¥ new_booking æµç¨‹ (LIFF)"); 
    return handleNewBooking(postData);
  } 
  
  else if (postData.events && postData.events.length > 0) {
    console.log("Log 3: é€²å…¥ LINE Webhook äº‹ä»¶æµç¨‹ (æŒ‰éˆ•)");
    postData.events.forEach(function(event) {
      if (event.type === 'postback') { 
        // âš ï¸ Webhook ä¾†è‡ª Admin Channel Bï¼Œæ‰€ä»¥ä½¿ç”¨ Admin Token
        handlePostback(ADMIN_CHANNEL_TOKEN, event); 
      }
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({status: 'success'})).setMimeType(ContentService.MimeType.JSON);
}

// ---------------------------------------------------------
// æµç¨‹å‡½å¼ï¼šè™•ç†æ–°è¨‚ä½ (ä½¿ç”¨ Admin Channel B Token æ¨æ’­çµ¦ Admin)
// ---------------------------------------------------------

function handleNewBooking(data) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    sheet.appendRow([
      new Date(), data.name, data.phone, data.email, 
      data.date, data.time, data.people, data.note, 
      data.userId, 'å¾…ç¢ºèª', 'æœªç™¼é€'
    ]);
    console.log("Log 4: Sheet å¯«å…¥æˆåŠŸï¼"); 
    
    const flexContent = createAdminFlex(data, sheet.getLastRow());
    // âš ï¸ æ¨æ’­çµ¦ Admin (ç”¨ Admin Channel B Token)
    pushFlex(ADMIN_CHANNEL_TOKEN, ADMIN_USER_ID, "æ–°è¨‚ä½é€šçŸ¥", flexContent); 
    
    return ContentService.createTextOutput(JSON.stringify({ status: 'success' })).setMimeType(ContentService.MimeType.JSON);
  } catch (e) {
    console.log("Log 5: å¯«å…¥æˆ–ç™¼é€å¤±æ•—: " + e.toString()); 
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: e.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ---------------------------------------------------------
// æµç¨‹å‡½å¼ï¼šè™•ç†æŒ‰éˆ•å›å‚³ (é‡é»ä¿®æ”¹è™•)
// ---------------------------------------------------------

function handlePostback(adminToken, event) {
  const data = JSON.parse(event.postback.data);
  const rowIndex = data.row;
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  
  // ğŸ” é™¤éŒ¯é» 1ï¼šç¢ºèªè®€å–çš„æ˜¯å“ªä¸€åˆ—ï¼Ÿ
  debugLog("é–‹å§‹è™•ç†æŒ‰éˆ•å›å‚³ï¼Œç›®æ¨™åˆ—è™Ÿï¼š" + rowIndex + "ï¼Œå‹•ä½œï¼š" + data.action);

  // è®€å–é¡§å®¢ ID (è«‹ç¢ºèªæ‚¨çš„ Sheet è£¡ï¼ŒUserID çœŸçš„æ˜¯åœ¨ç¬¬ 9 æ¬„ (Iæ¬„) å—ï¼Ÿ)
  const customerUserId = sheet.getRange(rowIndex, 9).getValue(); 
  
  // ğŸ” é™¤éŒ¯é» 2ï¼šç¢ºèªæŠ“åˆ°çš„ ID æ˜¯ä»€éº¼ï¼Ÿ
  debugLog("è®€å–åˆ°çš„é¡§å®¢ UserIDï¼š" + customerUserId);

  if (data.action === 'admin_approve') {
      sheet.getRange(rowIndex, 10).setValue('å·²ç¢ºèª');
      
      // 1. å›è¦† Admin
      pushMessage(adminToken, ADMIN_USER_ID, "âœ… è¨‚å–® #" + rowIndex + " å·²ç¢ºèª"); 

      // 2. é€šçŸ¥ Customer
      debugLog("æº–å‚™ç™¼é€çµ¦é¡§å®¢ï¼Œä½¿ç”¨ Token A (Customer Channel)");
      pushMessage(CUSTOMER_CHANNEL_TOKEN, customerUserId, 
                  "ğŸ‰ æ‚¨çš„è¨‚ä½ (è¨‚å–® #" + rowIndex + ") å·²è¢«é¤å»³ç¢ºèªï¼æœŸå¾…æ‚¨çš„å…‰è‡¨ï¼");
  }
  
  if (data.action === 'user_confirm_attendance') {
      sheet.getRange(rowIndex, 10).setValue('é¡§å®¢å·²äºŒç¢º');
      pushMessage(adminToken, ADMIN_USER_ID, "ğŸ”” é¡§å®¢å·²å®Œæˆå‡ºå¸­äºŒæ¬¡ç¢ºèª (è¨‚å–® #" + rowIndex + ")ã€‚");
  }
}

// ---------------------------------------------------------
// å·¥å…·å‡½å¼ï¼šFlex Message æ¨æ’­ (å¤šäº†ä¸€å€‹ token åƒæ•¸)
// ---------------------------------------------------------

function pushFlex(token, to, alt, contents) {
  console.log("æº–å‚™ç™¼é€ Flex çµ¦: " + to + " (Token: " + (token === ADMIN_CHANNEL_TOKEN ? "Admin" : "Customer") + ")");
  try {
    const res = UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
      method: 'post',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      payload: JSON.stringify({ to: to, messages: [{ type: "flex", altText: alt, contents: contents }] }),
      muteHttpExceptions: true
    });
    console.log("LINE Flex å›æ‡‰: " + res.getContentText()); 
  } catch (e) {
    console.log("LINE Flex ç™¼é€å´©æ½°: " + e.toString());
  }
}

// ---------------------------------------------------------
// å·¥å…·å‡½å¼ï¼šæ–‡å­—è¨Šæ¯æ¨æ’­ (å¤šäº†ä¸€å€‹ token åƒæ•¸)
// ---------------------------------------------------------

// ---------------------------------------------------------
// å·¥å…·å‡½å¼ï¼šæ–‡å­—è¨Šæ¯æ¨æ’­ (æœ€çµ‚åµéŒ¯ç‰ˆ)
// ---------------------------------------------------------
// ä¿®æ”¹å¾Œçš„æ¨æ’­å‡½å¼ (æœƒæŠŠçµæœå¯«å› Sheet)
function pushMessage(token, to, msg) {
  debugLog("æ­£åœ¨æ¨æ’­è¨Šæ¯çµ¦ï¼š" + to);
  
  try {
    const res = UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
      method: 'post',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      payload: JSON.stringify({ to: to, messages: [{ type: 'text', text: msg }] }),
      muteHttpExceptions: true // è®“å®ƒä¸è¦ç›´æ¥å ±éŒ¯ï¼Œé€™æ¨£æˆ‘å€‘æ‰èƒ½è®€å–éŒ¯èª¤ç¢¼
    });
    
    const responseCode = res.getResponseCode();
    const responseBody = res.getContentText();
    
    // ğŸ” é™¤éŒ¯é» 3ï¼šLINE åˆ°åº•å›å‚³äº†ä»€éº¼ï¼Ÿ
    debugLog("LINE å›æ‡‰ç¢¼ï¼š" + responseCode + "ï¼Œå›æ‡‰å…§å®¹ï¼š" + responseBody);
    
    if (responseCode !== 200) {
      debugLog("âŒ ç™¼é€å¤±æ•—ï¼è«‹æª¢æŸ¥ä¸Šé¢çš„å›æ‡‰å…§å®¹");
    }

  } catch (e) {
    debugLog("ğŸ’¥ ç¨‹å¼å´©æ½°ï¼š" + e.toString());
  }
}

// ---------------------------------------------------------
// å·¥å…·å‡½å¼ï¼šå»ºç«‹ç®¡ç†è€… Flex å¡ç‰‡ (ä¸è®Š)
// ---------------------------------------------------------

function createAdminFlex(data, row) {
  return {
    "type": "bubble",
    "body": { 
      "type": "box", "layout": "vertical", "contents": [
        { "type": "text", "text": "ğŸ”” æ–°è¨‚ä½", "weight": "bold", "size": "xl", "color": "#1DB446" },
        { "type": "text", "text": `${data.name} / ${data.people}ä½`, "margin": "md" },
        { "type": "text", "text": `${data.date} ${data.time}`, "weight": "bold", "size": "lg" }
    ]},
    "footer": { 
      "type": "box", "layout": "vertical", "contents": [
        { 
          "type": "button", 
          "style": "primary", 
          "color": "#06c755", 
          "action": { 
            "type": "postback", 
            "label": "âœ… ç¢ºèªæ¥å–®", 
            "data": JSON.stringify({ action: "admin_approve", row: String(row) }) 
          }
        }
    ]}
  };

  // â–¼â–¼â–¼ æŠŠé€™æ®µåŠ åœ¨ç¨‹å¼ç¢¼æœ€ä¸‹é¢ â–¼â–¼â–¼
function debugLog(msg) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName("Debug_Log");
    if (!sheet) {
      sheet = ss.insertSheet("Debug_Log"); // å¦‚æœæ²’æœ‰å°±è‡ªå‹•å»ºç«‹
      sheet.appendRow(["æ™‚é–“", "è¨Šæ¯å…§å®¹"]);
    }
    sheet.appendRow([new Date(), msg]);
  } catch (e) {
    // å¦‚æœé€£å¯« Log éƒ½å¤±æ•—ï¼Œé‚£å°±çœŸçš„æ²’è¾¦æ³•äº†
  }
}
// â–²â–²â–² é™¤éŒ¯å·¥å…·çµæŸ â–²â–²â–²
}